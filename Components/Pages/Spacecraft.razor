@*
    Spacecraft.razor

    Purpose:
        - Displays and explores spacecraft data stored locally (DB) and fetched from
            the SpaceDevs API via `SpaceDevsService`.
        - Provides search, sort, grid/list view, an expandable details card, and a
            simple SQL console for read-only SELECT queries against the local DB.

    Inputs / Dependencies:
        - Injected: `SpaceTrackerDbContext _context` for SQL console access and
            `SpaceDevsService spaceDevsService` for API-backed pagination.
        - Uses `spaceTracker.Models.Spacecraft` to render cards and details.

    Behavior / Notes:
        - The SQL console intentionally restricts to safe SELECT queries; keep the
            whitelist/blacklist in sync with security policy.
        - Images fall back to a placeholder when missing. Large page sizes are used
            (PageSize = 500) for initial loads; consider lowering if memory becomes
            an issue.
*@

@page "/spacecraft"
@using spaceTracker.Models
@using System.Text.RegularExpressions;
@using spaceTracker.Services
@using Microsoft.EntityFrameworkCore

@inject spaceTracker.Data.SpaceTrackerDbContext _context
@inject SpaceDevsService spaceDevsService
@rendermode InteractiveServer

<PageTitle>Spacecraft</PageTitle>

<h1>Spacecraft Explorer</h1>

<!-- Stats Bar -->
<div class="stats-bar">
    <div class="stat-item">
        <span class="stat-value">@spacecraftList.Count</span>
        <span class="stat-label">Loaded</span>
    </div>
    <div class="stat-item">
        <span class="stat-value">@FilteredSpacecraft.Count()</span>
        <span class="stat-label">Displayed</span>
    </div>
</div>

<!-- Search and Sort Bar -->
<div class="search-sort-bar">
    <input type="text"
           class="search-input"
           placeholder="Search spacecraft, type, or config..."
           @bind="searchTerm"
           @bind:event="oninput" />

    <select @bind="sortBy" class="sort-select">
        <option value="name">Sort: Name</option>
        <option value="type">Sort: Type</option>
        <option value="config">Sort: Config</option>
        <option value="maiden">Sort: Maiden Flight</option>
    </select>

    <button class="view-toggle" @onclick="ToggleView">
        @(isGridView ? "List View" : "Grid View")
    </button>
</div>

<!-- SQL Query Section -->
<div class="sql-query-section">
    <div class="sql-query-header">
        <h3> SQL Query Console</h3>
    </div>
    
    <div class="sql-query-content">
        <div class="sql-query-input">
            <textarea class="query-box"
                      placeholder="SELECT Name, SerialNumber FROM spacecraft WHERE Type = 'Crew Dragon' LIMIT 10"
                      @bind="sqlQuery"></textarea>

            <div class="query-buttons">
                <button class="run-query-button" @onclick="RunSqlQuery">
                    > Run Query
                </button>
            </div>
        </div>

        <div class="sql-examples">
            <h4>Database & Examples</h4>
            <div class="db-name">spacecraft</div>
            
            <div class="example-query" @onclick='() => sqlQuery = "SELECT COUNT(*) FROM spacecraft"'>
                SELECT COUNT(*) FROM spacecraft
            </div>
            
            <div class="example-query" @onclick='() => sqlQuery = "SELECT name, serial_number, created_at FROM spacecraft ORDER BY created_at DESC LIMIT 10"'>
                SELECT name, serial_number, created_at FROM spacecraft ORDER BY created_at DESC LIMIT 10
            </div>
            
            <div class="example-query" @onclick='() => sqlQuery = "SELECT name, description FROM spacecraft WHERE serial_number IS NOT NULL LIMIT 10"'>
                SELECT name, description FROM spacecraft WHERE serial_number IS NOT NULL LIMIT 10
            </div>
        </div>
    </div>
</div>

<!-- Query Results -->
@if (queryError != null)
{
    <div class="error-message"> @queryError</div>
}
else if (queryResults != null)
{
    <div class="query-results">
        <h3>Query Results (@queryResults.Count rows)</h3>
        <table>
            <thead>
                <tr>
                    @foreach (var col in queryResults.FirstOrDefault()?.Keys ?? Enumerable.Empty<string>())
                    {
                        <th>@col</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var row in queryResults)
                {
                    <tr>
                        @foreach (var val in row.Values)
                        {
                            <td>@(val?.ToString() ?? "NULL")</td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<!-- Spacecraft Grid/List -->
<div class="spacecraft-stack">
    @if (isLoading)
    {
        <div class="loading"><div class="spinner"></div> Loading spacecraft...</div>
    }
    else if (errorMessage != null)
    {
        <div class="error-message">@errorMessage</div>
    }
    else if (FilteredSpacecraft.Any())
    {
        <div class="@(isGridView ? "card-container" : "list-container")">
            @foreach (var craft in FilteredSpacecraft)
            {
                <div class="spacecraft-card @(isGridView ? "" : "list-view") @(expandedCardId == craft.Id ? "expanded" : "")"
                     @onclick="() => ToggleCardExpansion(craft.Id)">
                    <div class="card-content">
                        <div class="profile-header">
                            @if (!string.IsNullOrEmpty(craft.Image?.ImageUrl))
                            {
                                <img class="spacecraft-image" src="@craft.Image.ImageUrl" alt="@craft.Name" />
                            }
                            else
                            {
                                <div class="spacecraft-image placeholder">
                                    <span>@(string.IsNullOrEmpty(craft.Name) ? "?" : craft.Name[0].ToString())</span>
                                </div>
                            }

                            <div class="profile-info">
                                <h2>@craft.Name</h2>
                                <p class="serial">Serial: @craft.SerialNumber</p>
                                <p class="type">
                                    <span class="label">Type:</span>
                                    @if (!string.IsNullOrEmpty(craft.SpacecraftConfig?.Type?.Name))
                                    {
                                        <span class="badge">@craft.SpacecraftConfig.Type.Name</span>
                                    }
                                    else
                                    {
                                        <span class="badge unknown">Unknown</span>
                                    }
                                </p>
                                <p class="config">Config: @craft.SpacecraftConfig?.Name</p>

                                @if (expandedCardId != craft.Id && !isGridView)
                                {
                                    <p class="id">ID: @craft.Id</p>
                                }
                            </div>

                            <div class="expand-icon">
                                @(expandedCardId == craft.Id ? "▲" : "▼")
                            </div>
                        </div>

                        @if (expandedCardId == craft.Id)
                        {
                            <div class="expanded-details">
                                <div class="detail-section">
                                    <h3>Description</h3>
                                    <p>@(string.IsNullOrEmpty(craft.Description) ? "No description available" : craft.Description)</p>
                                </div>

                                <div class="detail-section">
                                    <h3>Maiden Flights</h3>
                                    <p><strong>@(craft.SpacecraftConfig?.Name ?? "Spacecraft") Maiden Flight:</strong> @(craft.SpacecraftConfig?.MaidenFlight ?? "Unknown")</p>

                                    @if (craft.SpacecraftConfig?.Family != null && craft.SpacecraftConfig.Family.Any())
                                    {
                                        @foreach (var family in craft.SpacecraftConfig.Family)
                                        {
                                            @if (!string.IsNullOrEmpty(family.MaidenFlight))
                                            {
                                                <p><strong>@family.Name Family's Maiden Flight:</strong> @family.MaidenFlight</p>
                                            }
                                        }
                                    }
                                </div>

                                @if (craft.SpacecraftConfig?.Family != null && craft.SpacecraftConfig.Family.Any())
                                {
                                    <div class="detail-section">
                                        <h3>Family</h3>
                                        @foreach (var family in craft.SpacecraftConfig.Family)
                                        {
                                            <p class="family-name">@family.Name</p>
                                            @if (!string.IsNullOrEmpty(family.Description))
                                            {
                                                <p class="family-description">@family.Description</p>
                                            }
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="detail-section">
                                        <h3>Family</h3>
                                        <p>No family information available.</p>
                                    </div>
                                }

                                <div class="detail-section">
                                    <h3>Technical Info</h3>
                                    <p><strong>Spacecraft ID:</strong> @craft.Id</p>
                                    <p><strong>Config ID:</strong> @craft.SpacecraftConfig?.Id</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

    }
    else if (string.IsNullOrWhiteSpace(searchTerm))
    {
        <p>No spacecraft found.</p>
    }
    else
    {
        <div class="no-results">
            <p>No spacecraft match "<strong>@searchTerm</strong>"</p>
            <button class="clear-search" @onclick="ClearSearch">Clear Search</button>
        </div>
    }
</div>

@code {
    private List<spaceTracker.Models.Spacecraft> spacecraftList = new();
    private bool isLoading = true;
    private string? errorMessage;
    private const int PageSize = 500;
    private int currentOffset = 0;
    private string searchTerm = string.Empty;
    private string sortBy = "name";
    private bool isLoadingMore = false;
    private int? expandedCardId = null;
    private bool isGridView = true;

    private string sqlQuery = string.Empty;
    private List<Dictionary<string, object>>? queryResults = null;
    private string? queryError = null;

    protected override async Task OnInitializedAsync() => await LoadSpacecraft(reset: true);

    private async Task LoadSpacecraft(bool reset = false)
    {
        try
        {
            if (reset)
            {
                isLoading = true;
                errorMessage = null;
                spacecraftList.Clear();
                currentOffset = 0;
            }
            else
            {
                isLoadingMore = true;
            }

            var list = await spaceDevsService.GetSpacecraftAsync(PageSize, currentOffset);
            if (list != null && list.Any())
            {
                spacecraftList.AddRange(list);
                currentOffset += PageSize;
            }
        }
        catch (Exception ex) { errorMessage = ex.Message; }
        finally { isLoading = false; isLoadingMore = false; }
    }

    private IEnumerable<spaceTracker.Models.Spacecraft> FilteredSpacecraft =>
        spacecraftList
            .Where(craft =>
                string.IsNullOrWhiteSpace(searchTerm)
                || (craft.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
                || (craft.SpacecraftConfig?.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
                || (craft.SpacecraftConfig?.Type?.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
                || (craft.SpacecraftConfig?.Family?.FirstOrDefault()?.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
            .OrderBy(craft =>
                sortBy == "name" ? craft.Name :
                sortBy == "type" ? craft.SpacecraftConfig?.Type?.Name :
                sortBy == "maiden" ? craft.SpacecraftConfig?.MaidenFlight ?? craft.SpacecraftConfig?.Family?.FirstOrDefault()?.MaidenFlight ?? "9999" :
                craft.SpacecraftConfig?.Name ?? "");

    private async Task LoadMore() => await LoadSpacecraft(reset: false);
    private void ToggleCardExpansion(int craftId) => expandedCardId = expandedCardId == craftId ? null : craftId;
    private void ShowRandomSpacecraft() { if (spacecraftList.Any()) { var random = new Random(); expandedCardId = spacecraftList[random.Next(spacecraftList.Count)].Id; searchTerm = string.Empty; } }
    private void ClearSearch() => searchTerm = string.Empty;
    private void ToggleView() { isGridView = !isGridView; expandedCardId = null; }

private async Task RunSqlQuery()
    {
        queryError = null;
        queryResults = null;
        if (string.IsNullOrWhiteSpace(sqlQuery)) { queryError = "Please enter a SQL query."; return; }

        // Security check: only allow SELECT queries
        var trimmedQuery = sqlQuery.Trim();
        if (!trimmedQuery.StartsWith("SELECT", StringComparison.OrdinalIgnoreCase))
        {
            queryError = "Only SELECT queries are allowed for safety.";
            return;
        }

        // Additional safety: block dangerous keywords
        var dangerousKeywords = new[] { "INSERT", "UPDATE", "DELETE", "DROP", "ALTER", "CREATE", "TRUNCATE", "EXEC", "EXECUTE" };
        var upperQuery = trimmedQuery.ToUpperInvariant();
        bool isDangerous = dangerousKeywords.Any(keyword => Regex.IsMatch(upperQuery, $@"\b{keyword}\b", RegexOptions.IgnoreCase));
        if (isDangerous)
        {
            queryError = "Query contains forbidden keywords. Only SELECT queries are allowed.";
            return;
        }

        try
        {
            using var connection = _context.Database.GetDbConnection();
            await connection.OpenAsync();

            using var command = connection.CreateCommand();
            command.CommandText = sqlQuery;
            command.CommandTimeout = 30; // 30 second timeout for safety

            using var reader = await command.ExecuteReaderAsync(System.Data.CommandBehavior.SequentialAccess);
            var results = new List<Dictionary<string, object>>();
            
            while (await reader.ReadAsync())
            {
                var row = new Dictionary<string, object>();
                for (int i = 0; i < reader.FieldCount; i++)
                {
                    var value = reader.IsDBNull(i) ? null : reader.GetValue(i);
                    row[reader.GetName(i)] = value ?? DBNull.Value;
                }
                results.Add(row);
                
                // Limit results to prevent memory issues
                if (results.Count >= 1000)
                {
                    queryError = "Query returned more than 1000 rows (truncated for display).";
                    break;
                }
            }
            
            queryResults = results;
        }
        catch (Exception ex) 
        { 
            queryError = $"Query error: {ex.Message}"; 
        }
    }
}
