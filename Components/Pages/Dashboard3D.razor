@page "/3d"
@using spaceTracker.Models
@using spaceTracker.Services
@inject SpaceDevsService spaceDevsService
@inject n2yoService n2yoService
@inject CesiumService cesiumService
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>3D Dashboard</PageTitle>

<h1>Upcoming Launch Locations</h1>

<button @onclick="ResetView" class="btn btn-primary mb-2">Reset View</button>

<div id="cesiumContainer" style="width: 100%; height: 90vh;"></div>

@code {
    private List<SpaceDevsLaunch> launches = new();
    private SatellitePosition? issPosition;
    private System.Threading.Timer? _timer;
    private string? _issMarkerId;
    
    protected override async Task OnInitializedAsync()
    {
        launches = await spaceDevsService.GetUpcomingLaunchesAsync(5);
        issPosition = await n2yoService.GetISSPosition(42.2626, -71.8023, 0);
        
        // Update ISS every 5 seconds
        _timer = new System.Threading.Timer(async _ => await UpdateISSPosition(), null, 5000, 5000);
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await cesiumService.InitializeGlobeAsync("cesiumContainer");
            
            // Add launch site markers from real data
            foreach (var launch in launches)
            {
                if (launch.Pad?.latitude != null && launch.Pad?.longitude != null)
                {
                    await cesiumService.AddMarkerAsync(
                        launch.Pad.latitude.Value,
                        launch.Pad.longitude.Value,
                        launch.Name,
                            $"<h3>{launch.Name}</h3>" +
                            $"<b>Mission:</b> {launch.Mission?.Description ?? "No description"}<br/>" +
                            $"<b>Launch:</b> {launch.Net?.ToString("g") ?? "TBD"}<br/>" +
                            $"<b>Provider:</b> {launch.Provider?.Name ?? "Unknown"}<br/>" +
                            $"<b>Location:</b> {launch.Pad?.Location?.Name ?? "Unknown"}"
                    );
                }
            }
            
            // Add ISS marker
            if (issPosition?.Positions?.Count > 0)
            {
                var pos = issPosition.Positions[0];
                _issMarkerId = await cesiumService.AddISSMarkerAsync(
                    pos.Satlatitude,
                    pos.Satlongitude,
                    "ISS",
                    $"<h3>International Space Station</h3>" +
                    $"<b>Altitude:</b> {pos.Sataltitude:F2} km<br/>" +
                    $"<b>Latitude:</b> {pos.Satlatitude:F4}°<br/>" +
                    $"<b>Longitude:</b> {pos.Satlongitude:F4}°<br/><br/>" +
                    $"<b>Live Stream:</b> <a href='https://www.youtube.com/watch?v=fO9e9jnhYK8'>Watch on YouTube</a>"
                );
            }
        }
    }

    private async Task UpdateISSPosition()
    {
        var newPosition = await n2yoService.GetISSPosition(42.2626, -71.8023, 0);
        
        if (newPosition?.Positions?.Count > 0 && !string.IsNullOrEmpty(_issMarkerId))
        {
            var pos = newPosition.Positions[0];
            await cesiumService.UpdateMarkerAsync(_issMarkerId, pos.Satlatitude, pos.Satlongitude);
            issPosition = newPosition;
        }
    }

    private async Task ResetView()
    {
        await cesiumService.ResetViewAsync();
    }
    
    public async ValueTask DisposeAsync()
    {
        _timer?.Dispose();
        try
        {
            await cesiumService.DisposeAsync();
        }
        catch (JSDisconnectedException) { }
    }
}
