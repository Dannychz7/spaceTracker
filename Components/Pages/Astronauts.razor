@page "/astronauts"
@using spaceTracker.Models
@using spaceTracker.Services
@inject SpaceDevsService spaceDevsService
@rendermode InteractiveServer

<PageTitle>Astronauts</PageTitle>

<h1>Famous Astronauts</h1>

<div class="search-container">
    <input type="text" 
           placeholder="Search astronaut..." 
           @bind="searchTerm" 
           @bind:event="oninput" 
           @onkeyup="OnSearchInput" />
    
    @if (!string.IsNullOrEmpty(searchTerm) && showSearchPreview)
    {
        <div class="search-preview">
            @if (searchPreviewResults.Any())
            {
                @foreach (var astronaut in searchPreviewResults.Take(5))
                {
                    <div class="search-preview-item" @onclick="() => SelectAstronautFromPreview(astronaut)">
                        @if (astronaut.Image?.ImageUrl != null)
                        {
                            <img src="@astronaut.Image.ImageUrl" alt="@astronaut.Name" class="search-preview-image" />
                        }
                        else if (!string.IsNullOrEmpty(astronaut.ProfileImageThumbnail))
                        {
                            <img src="@astronaut.ProfileImageThumbnail" alt="@astronaut.Name" class="search-preview-image" />
                        }
                        else
                        {
                            <div class="search-preview-image placeholder">
                                <span>@(astronaut.Name?[0])</span>
                            </div>
                        }
                        <div class="search-preview-info">
                            <div class="search-preview-name">@astronaut.Name</div>
                            <div class="search-preview-agency">@astronaut.Agency?.Name</div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="search-preview-item">
                    No matching astronauts found
                </div>
            }
        </div>
    }
</div>

<div class="astronaut-stack">
    @if (!string.IsNullOrEmpty(searchTerm) && !FilteredAstronauts.Any())
    {
        <div class="no-results">
            <h3>No Astronauts Found</h3>
            <p>No astronauts match your search term "@searchTerm"</p>
            <div class="suggestion">
                Try:
                <ul>
                    <li>Checking for typos</li>
                    <li>Using fewer keywords</li>
                    <li>Searching by nationality or agency</li>
                </ul>
            </div>
        </div>
    }
    else if (FilteredAstronauts.Any())
    {
        <div class="card-container">
            @foreach (var astronaut in FilteredAstronauts)
            {
                var index = FilteredAstronauts.ToList().IndexOf(astronaut);
                <div class="astronaut-card @(index == currentIndex ? "active" : "")"
                     style="transform: translateX(@(100 * (index - currentIndex))%) scale(@(index == currentIndex ? "1" : "0.9"))">
                    <div class="card-content">

                <div class="profile-header">
                    @if (astronaut.Image?.ImageUrl != null)
                    {
                        <img src="@astronaut.Image.ImageUrl" alt="@astronaut.Name" class="astronaut-image" />
                    }
                    else if (!string.IsNullOrEmpty(astronaut.ProfileImage))
                    {
                        <img src="@astronaut.ProfileImage" alt="@astronaut.Name" class="astronaut-image" @onerror="e => OnImageError(e, astronaut)" />
                    }
                    else if (!string.IsNullOrEmpty(astronaut.ProfileImageThumbnail))
                    {
                        <img src="@astronaut.ProfileImageThumbnail" alt="@astronaut.Name" class="astronaut-image" />
                    }
                    else
                    {
                        <div class="astronaut-image placeholder">
                            <span>@(astronaut.Name?[0])</span>
                        </div>
                    }
                    <div class="profile-info">
                        <h2>@astronaut.Name</h2>
                        <p class="nationality">@(string.Join(", ", astronaut.Nationality?.Select(n => n.NationalityName) ?? Array.Empty<string>()))</p>
                        <p class="status @(astronaut.Status?.Name?.ToLower() ?? "unknown")">@(astronaut.Status?.Name ?? "Status Unknown")</p>
                        <p class="agency">@astronaut.Agency?.Name</p>
                    </div>
                </div>

                <div class="stats-dashboard">
                            <div class="stat-group">
                                <div class="stat">
                                    <span class="number">@astronaut.FlightsCount</span>
                                    <span class="label">Flights</span>
                                </div>
                                <div class="stat">
                                    <span class="number">@astronaut.LandingsCount</span>
                                    <span class="label">Landings</span>
                                </div>
                                <div class="stat">
                                    <span class="number">@astronaut.SpacewalksCount</span>
                                    <span class="label">Spacewalks</span>
                                </div>
                            </div>
                            @if (!string.IsNullOrEmpty(astronaut.TimeInSpace))
                            {
                                <div class="time-in-space">
                                    <span class="label">Time in Space:</span>
                                    <span class="value">@FormatTimeInSpace(astronaut.TimeInSpace)</span>
                                </div>
                            }
                        </div>

                        <div class="career-timeline">
                            @if (astronaut.FirstFlight.HasValue || astronaut.LastFlight.HasValue)
                            {
                                <h3>Career Timeline</h3>
                                @if (astronaut.FirstFlight.HasValue)
                                {
                                    <div class="timeline-entry">
                                        <span class="date">@astronaut.FirstFlight.Value.ToString("MMMM d, yyyy")</span>
                                        <span class="event">First Space Flight</span>
                                    </div>
                                }
                                @if (astronaut.LastFlight.HasValue && astronaut.LastFlight != astronaut.FirstFlight)
                                {
                                    <div class="timeline-entry">
                                        <span class="date">@astronaut.LastFlight.Value.ToString("MMMM d, yyyy")</span>
                                        <span class="event">Last Space Flight</span>
                                    </div>
                                }
                            }
                        </div>

                        @if (!string.IsNullOrEmpty(astronaut.Bio))
                        {
                            <div class="biography">
                                <h3>Biography</h3>
                                <p>@astronaut.Bio</p>
                            </div>
                        }

                        <div class="social-links">
                            @if (!string.IsNullOrEmpty(astronaut.Twitter))
                            {
                                <a href="@astronaut.Twitter" target="_blank" class="social-link twitter">
                                    Twitter
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(astronaut.Instagram))
                            {
                                <a href="@astronaut.Instagram" target="_blank" class="social-link instagram">
                                    Instagram
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(astronaut.Wiki))
                            {
                                <a href="@astronaut.Wiki" target="_blank" class="social-link wiki">
                                    Wikipedia
                                </a>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="navigation-buttons">
            <button @onclick="ShowPrevious" disabled="@(currentIndex == 0)">Previous</button>
            <button @onclick="ShowNext" disabled="@(currentIndex >= FilteredAstronauts.Count() - 1)">Next</button>
        </div>
        
        @if (astronauts.Count >= PageSize)
        {
            <div class="load-more">
                <button @onclick="LoadMoreAstronauts" class="load-more-button">Load More Astronauts</button>
            </div>
        }
    }
    else
    {
        <p>Loading astronauts...</p>
    }
</div>

@code {
    private string searchTerm = string.Empty;
    private List<Astronaut> astronauts = new();
    private List<Astronaut> searchPreviewResults = new();
    private bool showSearchPreview = false;
    private int currentIndex = 0;
    private int currentOffset = 0;
    private const int PageSize = 50; // Increased to get more astronauts

    protected override async Task OnInitializedAsync()
    {
        await LoadAstronauts();
        await base.OnInitializedAsync();
    }

    private async Task LoadAstronauts(bool append = false)
    {
        try
        {
            var newAstronauts = await spaceDevsService.GetAstronautsAsync(
                limit: PageSize, 
                offset: append ? currentOffset + PageSize : 0, 
                search: searchTerm
            );

            if (append && newAstronauts.Any())
            {
                astronauts.AddRange(newAstronauts);
                currentOffset += PageSize;
            }
            else
            {
                astronauts = newAstronauts;
                currentOffset = 0;
                currentIndex = 0;
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading astronauts: {ex.Message}");
        }
    }

    private async Task LoadMoreAstronauts()
    {
        await LoadAstronauts(append: true);
    }

    private void ShowNext()
    {
        if (currentIndex < astronauts.Count - 1)
        {
            currentIndex++;
            StateHasChanged();
        }
    }

    private void ShowPrevious()
    {
        if (currentIndex > 0)
        {
            currentIndex--;
            StateHasChanged();
        }
    }

    private async Task OnSearchChanged()
    {
        currentIndex = 0;
        currentOffset = 0;
        await LoadAstronauts();
    }

    private IEnumerable<Astronaut> FilteredAstronauts => astronauts;

    private async Task OnSearchInput(KeyboardEventArgs e)
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            showSearchPreview = false;
            searchPreviewResults.Clear();
            return;
        }

        showSearchPreview = true;
        searchPreviewResults = astronauts
            .Where(a => (a.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                       (a.Agency?.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                       (a.Nationality != null && a.Nationality.Any(n => n.NationalityName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)))
            .ToList();

        if (e.Key == "Enter")
        {
            await OnSearchChanged();
            showSearchPreview = false;
        }
    }

    private void SelectAstronautFromPreview(Astronaut selected)
    {
        showSearchPreview = false;
        var index = astronauts.IndexOf(selected);
        if (index != -1)
        {
            currentIndex = index;
            StateHasChanged();
        }
    }

    private void OnImageError(Microsoft.AspNetCore.Components.Web.ErrorEventArgs e, Astronaut astronaut)
    {
        // If the main image fails, try to fall back to the thumbnail
        if (!string.IsNullOrEmpty(astronaut.ProfileImage) && !string.IsNullOrEmpty(astronaut.ProfileImageThumbnail))
        {
            astronaut.ProfileImage = astronaut.ProfileImageThumbnail;
            StateHasChanged();
        }
    }

    private string FormatTimeInSpace(string? isoDuration)
    {
        if (string.IsNullOrEmpty(isoDuration))
            return "Unknown";

        try
        {
            // Remove the 'P' prefix and split between days (D) and time (T)
            var parts = isoDuration.TrimStart('P').Split('T');
            
            // Parse days
            var days = 0;
            if (parts[0].Contains("D"))
            {
                days = int.Parse(parts[0].TrimEnd('D'));
            }

            // Parse hours, minutes, seconds if they exist
            var hours = 0;
            var minutes = 0;
            var seconds = 0;
            
            if (parts.Length > 1)
            {
                var timePart = parts[1];
                
                if (timePart.Contains("H"))
                {
                    var hourIndex = timePart.IndexOf("H");
                    hours = int.Parse(timePart[..hourIndex]);
                    timePart = timePart[(hourIndex + 1)..];
                }
                
                if (timePart.Contains("M"))
                {
                    var minIndex = timePart.IndexOf("M");
                    minutes = int.Parse(timePart[..minIndex]);
                    timePart = timePart[(minIndex + 1)..];
                }
                
                if (timePart.Contains("S"))
                {
                    seconds = int.Parse(timePart.TrimEnd('S'));
                }
            }

            // Build the readable string
            var timeComponents = new List<string>();
            
            if (days > 0)
                timeComponents.Add($"{days} day{(days != 1 ? "s" : "")}");
            if (hours > 0)
                timeComponents.Add($"{hours} hour{(hours != 1 ? "s" : "")}");
            if (minutes > 0)
                timeComponents.Add($"{minutes} minute{(minutes != 1 ? "s" : "")}");
            if (seconds > 0 && days == 0) // Only show seconds if less than a day
                timeComponents.Add($"{seconds} second{(seconds != 1 ? "s" : "")}");

            return string.Join(", ", timeComponents);
        }
        catch
        {
            return "Format Error";
        }
    }
}
